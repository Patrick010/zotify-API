# Phase 5: IPC Communication Layer

This document outlines the secure Inter-Process Communication (IPC) mechanism implemented between the Zotify API and the Snitch helper application.

## Architecture

The communication relies on a one-shot IPC server running within the Zotify API process and a corresponding HTTP client within Snitch. This avoids complexities of other IPC methods while remaining secure and cross-platform.

### Authentication Flow Diagram

Here is a step-by-step visualization of the entire authentication flow, from the user's request to the final code capture.

```
+-------------+      +-----------------+      +----------+      +----------+
| User Client |      | Zotify API      |      |  Snitch  |      | Spotify  |
+-------------+      +-----------------+      +----------+      +----------+
       |                     |                      |                 |
       | POST /auth/login    |                      |                 |
       |-------------------->|                      |                 |
       |                     | 1. Gen state & token |                 |
       |                     | 2. Start IPC Server  |                 |
       |                     | 3. Launch Snitch ----|---------------->|
       |                     |    (pass tokens)     |                 |
       |                     |                      | 4. Start Server |
       |                     |                      | on :21371       |
       |                     |                      |                 |
       | 4. Return auth URL  |                      |                 |
       |<--------------------|                      |                 |
       |                     |                      |                 |
       | 5. User opens URL,  |                      |                 |
       |    authenticates    |--------------------------------------->|
       |                     |                      |                 |
       |                     |                      |   6. Redirect   |
       |                     |<---------------------------------------|
       |                     |                      | to Snitch       |
       |                     |                      | with code&state |
       |                     |                      |                 |
       |                     |   +------------------|
       |                     |   |                  |
       |                     |   | 7. Validate state|
       |                     |   |    & POST code   |
       |                     |   |    to IPC Server |
       |                     |   V                  |
       |               8. Validate token |          |
       |                  & store code   |          |
       |                     |           | 9. Shutdown|
       |                     |<----------|            |
       |                     |           |            |
       | 9. Return success   |           |            |
       |<--------------------|           |            |
       |                     |           |            |
```

### Key Components

1.  **Zotify API `/auth/login` Endpoint**: The entry point for the user. It orchestrates the entire process.
2.  **IPC Server (in Zotify API)**: A temporary, single-request HTTP server started in a background thread. It listens on a local port (e.g., 9999) for the code from Snitch. It uses a secure, one-time `ipc-token` for authentication.
3.  **Snitch Process**: A short-lived helper application.
    -   **Listener**: It runs its own HTTP server on `localhost:21371` to receive the `GET /callback` redirect from Spotify in the user's browser.
    -   **IPC Client**: After capturing the code, it acts as an HTTP client, making a `POST` request to the IPC Server within the Zotify API to securely deliver the code.
4.  **Tokens**:
    -   `state`: A random string used to prevent CSRF attacks during the Spotify redirect. Generated by Zotify API, passed to Snitch, and validated by Snitch.
    -   `ipc-token`: A random string used as a bearer token to authenticate the request from Snitch to the Zotify API's IPC server, ensuring no other local process can submit a code.
