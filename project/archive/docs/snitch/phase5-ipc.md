<!-- ID: DOC-042 -->
# Phase 5: IPC Communication Layer

This document outlines the secure Inter-Process Communication (IPC) mechanism implemented between the Zotify API and the Snitch helper application.

## Architecture

The communication relies on a one-shot IPC server running within the Zotify API process and a corresponding HTTP client within Snitch. This avoids complexities of other IPC methods while remaining secure and cross-platform.

### Authentication Flow Diagram

Here is a step-by-step visualization of the entire authentication flow, from the user's request to the final code capture.

```
+-------------+      +-----------------+      +----------+      +----------+
| User Client |      | Zotify API      |      |  Snitch  |      | Spotify  |
+-------------+      +-----------------+      +----------+      +----------+
       |                     |                      |                 |
       | POST /auth/login    |                      |                 |
       |-------------------->|                      |                 |
       |                     | 1. Gen state & token |                 |
       |                     | 2. Start IPC Server  |                 |
       |                     | 3. Launch Snitch ----|---------------->|
       |                     |    (pass tokens)     |                 |
       |                     |                      | 4. Start Server |
       |                     |                      | on :21371       |
       |                     |                      |                 |
       | 4. Return auth URL  |                      |                 |
       |<--------------------|                      |                 |
       |                     |                      |                 |
       | 5. User opens URL,  |                      |                 |
       |    authenticates    |--------------------------------------->|
       |                     |                      |                 |
       |                     |                      |   6. Redirect   |
       |                     |<---------------------------------------|
       |                     |                      | to Snitch       |
       |                     |                      | with code&state |
       |                     |                      |                 |
       |                     |   +------------------|
       |                     |   |                  |
       |                     |   | 7. Validate state|
       |                     |   |    & POST code   |
       |                     |   |    to IPC Server |
       |                     |   V                  |
       |               8. Validate token |          |
       |                  & store code   |          |
       |                     |           | 9. Shutdown|
       |                     |<----------|            |
       |                     |           |            |
       | 9. Return success   |           |            |
       |<--------------------|           |            |
       |                     |           |            |
```

### Key Components

1.  **Zotify API `/auth/login` Endpoint**: The entry point for the user. It orchestrates the entire process by generating tokens and launching the other components. It blocks until the flow is complete or times out.

2.  **IPC Server (in Zotify API)**: A temporary, single-request HTTP server started in a background thread from `auth_service.py`. It listens on `127.0.0.1:9999`. Its sole purpose is to listen for a `POST` to `/zotify/receive-code`, validate the `ipc-token` in the `Authorization` header, and capture the `code` from the JSON body. It shuts down immediately after handling this one request.

3.  **Snitch Process**: A short-lived helper application written in Go.
    -   **Listener**: It runs its own HTTP server on `127.0.0.1:21371` to receive the `GET /callback` redirect from Spotify in the user's browser. This is the official `redirect_uri` registered with Spotify.
    -   **IPC Client**: After capturing and validating the `code` and `state` from the browser redirect, it immediately makes a `POST` request to the IPC Server (`http://127.0.0.1:9999/zotify/receive-code`), sending the captured `code` in a JSON payload.

4.  **Tokens**:
    -   `state`: A cryptographically secure random string used to prevent CSRF attacks. It is generated by the Zotify API, passed to Snitch via a `-state` flag, included in the Spotify URL, and validated by Snitch upon receiving the callback.
    -   `ipc-token`: A second cryptographically secure random string used as a bearer token to authenticate the request from Snitch to the Zotify API's IPC server. This ensures no other local process can maliciously (or accidentally) send a code to the IPC listener. It is passed to Snitch via an `-ipc-token` flag.
